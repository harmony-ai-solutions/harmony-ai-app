# Harmony AI App Active Context
@Focus:
- Multi-Connection WebSocket Architecture: Refactored to support multiple concurrent connections (sync + entity sessions).
- Sync Services Implementation Complete: EventEmitter3-based event system, WebSocket/WSS support, handshake protocol.
- Database Implementation Complete: SQLCipher encryption, full repository layer (84 tests), in-app DEV-only test runner, sync tables added.
- Test Runner Integration: DatabaseTestScreen in Settings menu, real-time console, color-coded results, themed UI.
- Advanced Theming: RGB editor, custom theme creation/deletion, JSON import/export, 6 built-in themes.
- Bootstrap Complete: RN 0.83.1, TypeScript, navigation, Paper UI, organized structure.
@Next:
- Sync Testing: Test handshake flow with Harmony Link, verify HANDSHAKE_PENDING → ACCEPT → WSS upgrade.
- Sync Protocol: Test SYNC_REQUEST → SYNC_DATA exchange → SYNC_COMPLETE flow.
- Chat Interface: Message list (FlatList), bubbles (user/AI), text input, timestamps.
- Message Persistence: SQLite message storage with sync, offline queue, sync tracking.
- Character Management: Selection UI, profile display, avatar loading, character switching.
@Decisions:
- React Native CLI (not Expo) for full native module control (Executorch, messenger APIs).
- React Native Paper for Material Design 3 consistency.
- React Navigation for type-safe routing.
- TypeScript strict mode for type safety.
- Hooks → Redux/Zustand as complexity grows.
- Dark theme default (matches Harmony Link, OLED-friendly).
- Database schema 100% compatible with Harmony Link for bidirectional sync.
- DEV-only test runner using __DEV__ checks for production safety.
@Learnings:
- Metro bundler hot reload excellent with TypeScript.
- React Native Paper dark theme integration smooth.
- Migration from react-native-document-picker to @react-native-documents/picker fixed RN 0.83.1 compatibility.
- Gradle 8.13 required (NOT 9.0+) for RN 0.83.1.
- Database encryption with SQLCipher + React Native Keychain provides secure storage.
- In-app test runner provides better developer experience than Node-based tests.
- BLOB handling in SQLite requires Uint8Array → Base64 conversion for UI.
- __DEV__ checks ensure development tools invisible in production builds.
- ADB PATH setup critical for newcomers.
- Good foundation prevents technical debt.
- EventEmitter3 (~2KB) provides type-safe, reliable event handling for React Native (Node.js EventEmitter unreliable).
- TypeScript generics for EventEmitter interfaces enable compile-time event validation.
- Comprehensive logging with [ServiceName] prefix critical for debugging async WebSocket flows.
- Android emulator uses 10.0.2.2 to access host's localhost (not 127.0.0.1).
- Harmony Link must bind to 0.0.0.0 (not localhost) for emulator connectivity.
- HANDSHAKE_PENDING event handler essential for user feedback during device approval.
- ConnectionManager pattern enables multiple concurrent connections with independent lifecycles and event routing.
- Decoupling transport layer from service logic improves testability and scalability.
- Context separation (SyncConnectionContext vs EntitySessionContext) provides clear responsibility boundaries.
- React useRef critical for avoiding stale closures in setTimeout/async callbacks (reconnect counter).
- Reconnect race condition fix: Only schedule reconnect from disconnected event if NOT in isConnecting state (prevents double-scheduling when connection attempt fails).
- Event listener accumulation: Always call removeAllListeners() before disconnecting to prevent duplicate error messages from old listeners.
- Auto-reconnect strategy: Always retry regardless of error type, exponential backoff [1s, 2s, 4s, 8s, 16s, 30s].
@Implementation[Sync]:
- Multi-Connection Architecture: ConnectionManager manages multiple WebSocket connections (sync + entity sessions).
- Services[4]: ConnectionManager (transport pool), SyncService (protocol logic), EntitySessionService (session management), ConnectionStateManager (JWT lifecycle).
- Contexts[2]: SyncConnectionContext (sync connection state/actions), EntitySessionContext (entity session management).
- EventEmitter3: Type-safe pub/sub pattern, connection-specific event routing (event:sync, event:entity).
- Protocol: HANDSHAKE_REQUEST → PENDING → ACCEPT → WSS upgrade → SYNC_REQUEST → DATA exchange → COMPLETE → FINALIZE.
- Entity Sessions: Mirror Harmony Link's EntitySessionManager pattern, on-demand connections per chat.
- Screens[2]: ConnectionSetupScreen (IP/port input, handshake), SyncSettingsScreen (status, manual sync).
- Database: sync_devices, sync_history, chat_messages tables (migration 000005).
- Error Handling: Connection validation, timeout handling (30s), confirmation tracking, comprehensive logging.
